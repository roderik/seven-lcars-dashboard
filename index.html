<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LCARS ‚Ä¢ Command Center</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üññ</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Antonio:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        lcars: {
                            orange: '#FF9900',
                            gold: '#FFCC99',
                            purple: '#CC99CC',
                            violet: '#9999CC',
                            blue: '#9999FF',
                            sky: '#99CCFF',
                            red: '#CC6666',
                            pink: '#CC6699',
                            green: '#99CC99',
                            teal: '#66CCCC',
                            tan: '#CC9966',
                            peach: '#FFCC66',
                            bg: '#000000',
                            white: '#FFFFCC',
                            panel: 'rgba(20, 20, 30, 0.95)'
                        },
                        status: {
                            active: '#99FF99',
                            warning: '#FFCC00',
                            alert: '#FF6666',
                            offline: '#666666'
                        }
                    },
                    fontFamily: {
                        lcars: ['Antonio', 'Helvetica Neue', 'Arial', 'sans-serif']
                    },
                    borderRadius: {
                        'lcars': '25px',
                        'lcars-sm': '15px',
                        'lcars-xs': '10px'
                    },
                    animation: {
                        'twinkle': 'twinkle var(--duration) ease-in-out infinite',
                        'pulse-badge': 'pulse-badge 2s infinite',
                        'status-blink': 'statusBlink 1.5s ease-in-out infinite'
                    },
                    keyframes: {
                        twinkle: {
                            '0%, 100%': { opacity: 'var(--base-opacity)' },
                            '50%': { opacity: '1' }
                        },
                        'pulse-badge': {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.6' }
                        },
                        statusBlink: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.4' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Starfield */
        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle var(--duration) ease-in-out infinite;
        }
        @keyframes twinkle {
            0%, 100% { opacity: var(--base-opacity); }
            50% { opacity: 1; }
        }

        /* Scanlines */
        .scanlines {
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.1) 0px,
                rgba(0, 0, 0, 0.1) 1px,
                transparent 1px,
                transparent 3px
            );
        }

        /* Sidebar elbow shapes */
        .sidebar-elbow-bottom {
            border-radius: 0 0 0 25px;
        }
        
        /* Header elbow */
        .header-elbow {
            border-radius: 0 0 25px 0;
        }
        
        /* Footer elbow */
        .footer-elbow {
            border-radius: 0 25px 0 0;
        }

        /* Kanban drag state */
        .task-card.dragging { opacity: 0.5; }

        /* Activity log types */
        .activity-log-type.status { background: #99CC99; color: #000; }
        .activity-log-type.comment { background: #99CCFF; color: #000; }
        .activity-log-type.system { background: #FF9900; color: #000; }
        .activity-log-type.update { background: #CC99CC; color: #000; }
        .activity-log-type.tool { background: #66CCCC; color: #000; }
        .activity-log-type.thinking { background: #9999FF; color: #000; }
        .activity-log-type.building { background: #99FF99; color: #000; }
        .activity-log-type.research { background: #FFCC66; color: #000; }

        /* Toast notifications */
        .toast {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            background: rgba(20, 20, 30, 0.98);
            border: 2px solid;
            border-radius: 12px;
            color: #FFCC99;
            font-family: 'Antonio', sans-serif;
            font-size: 13px;
            font-weight: 600;
            min-width: 280px;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), 0 0 20px rgba(255, 153, 0, 0.15);
            backdrop-filter: blur(10px);
            animation: toastSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-left-width: 4px;
        }

        .toast.completed { border-color: #99CC99; border-left-color: #99CC99; }
        .toast.engineering { border-color: #9999FF; border-left-color: #9999FF; }
        .toast.communications { border-color: #99CCFF; border-left-color: #99CCFF; }
        .toast.research { border-color: #FFCC66; border-left-color: #FFCC66; }
        .toast.trading { border-color: #99FF99; border-left-color: #99FF99; }
        .toast.priority { border-color: #FF6666; border-left-color: #FF6666; }
        .toast.default { border-color: #CC9966; border-left-color: #CC9966; }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        @keyframes toastSlideOut {
            to {
                opacity: 0;
                transform: translateX(50px) scale(0.95);
            }
        }

        .toast-exit {
            animation: toastSlideOut 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards !important;
        }

        .toast-icon { font-size: 24px; flex-shrink:0; }
        .toast-content { flex: 1; }
        .toast-title { font-size: 12px; font-weight: 700; margin-bottom: 2px; }
        .toast-message { font-size: 13px; color: #999; }
        .toast-close { background: none; border: none; color: #666; font-size: 18px; cursor: pointer; padding: 0 4px; transition: color 0.2s; }
        .toast-close:hover { color: #FF6666; }

        /* Platform badges */
        .platform-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 3px;
            letter-spacing: 0.5px;
        }
        .platform-badge.github { background: #333; color: #fff; }
        .platform-badge.cli { background: #4A4A4A; color: #00FF00; }
        .platform-badge.telegram { background: #0088cc; color: #fff; }
        .platform-badge.gmail { background: #EA4335; color: #fff; }
        .platform-badge.moltbook { background: #7C3AED; color: #fff; }
        .platform-badge.polymarket { background: #1652F0; color: #fff; }
        .platform-badge.research { background: #FF9900; color: #000; }
        .platform-badge.qc { background: #00CED1; color: #000; }
        .platform-badge.review { background: #CC99CC; color: #000; }
        
        /* Model tier badges (compact) */
        .model-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 700;
        }
        .model-badge.opus { background: #9b59b6; color: #fff; }
        .model-badge.codex { background: #27ae60; color: #fff; }
        .model-badge.minimax { background: #3498db; color: #fff; }

        /* Expandable activity entries */
        .activity-entry { cursor: pointer; }
        .activity-entry:hover { background: rgba(255, 153, 0, 0.15); }
        .activity-details {
            display: none;
            margin-top: 8px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 6px;
            border-left: 2px solid #CC99CC;
        }
        .activity-entry.expanded .activity-details { display: block; }
        .activity-expand-icon {
            transition: transform 0.2s ease;
            font-size: 12px;
            opacity: 0.7;
        }
        .activity-entry.expanded .activity-expand-icon { transform: rotate(90deg); }

        /* Agent state colors */
        .agent-state.thinking { background: #9999FF; color: #000; animation: pulse-badge 1.5s infinite; }
        .agent-state.building { background: #99FF99; color: #000; animation: pulse-badge 1s infinite; }
        .agent-state.researching { background: #FFCC66; color: #000; animation: pulse-badge 2s infinite; }
        .agent-state.waiting { background: #FFCC00; color: #000; animation: statusBlink 2s infinite; }
        .agent-state.idle { background: #9999CC; color: #000; }
        .agent-state.offline { background: #666666; color: #fff; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.3); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #CC9966; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #FF9900; }

        /* Responsive */
        @media (max-width: 1200px) {
            .agents-panel { }
            .shortcuts-hint { display: none !important; }
            .mission-content { grid-template-columns: 1fr 1fr !important; }
        }
        @media (max-width: 768px) {
            .lcars-frame { grid-template-columns: 1fr !important; }
            .lcars-sidebar { display: none !important; }
            .stats-bar, .mission-content { grid-column: 1 !important; }
            .mission-content { grid-template-columns: 1fr !important; }
            .feed-panel { max-height: 200px; }
        }
    </style>
</head>
<body class="bg-lcars-bg text-lcars-orange font-lcars min-h-screen overflow-hidden">
    <!-- Starfield -->
    <div id="starfield" class="fixed inset-0 pointer-events-none -z-10"></div>
    
    <!-- Scanlines -->
    <div class="scanlines fixed inset-0 pointer-events-none z-[1000] opacity-30"></div>

    <!-- Main Frame -->
    <div class="lcars-frame grid grid-cols-[140px_1fr] grid-rows-[70px_auto_1fr_50px] h-screen relative z-10">
        
        <!-- Header -->
        <header class="col-span-2 flex items-stretch">
            <div class="header-elbow w-40 bg-lcars-purple flex items-center justify-center text-xs font-bold text-lcars-bg tracking-wider cursor-pointer hover:brightness-125 transition-all">
                LCARS 47.6
            </div>
            <div class="flex-1 flex items-stretch gap-1 pl-1">
                <div id="stardate" class="flex-1 bg-lcars-purple flex items-center justify-center px-4 text-sm font-medium text-lcars-bg uppercase tracking-wider hover:brightness-125 transition-all">
                    47085.2
                </div>
                <div class="bg-lcars-bg text-lcars-purple px-6 text-2xl font-bold tracking-[4px] flex items-center drop-shadow-[0_0_20px_rgba(204,153,204,0.5)]">
                    COMMAND CENTER
                </div>
                <div id="clock" class="flex-[2] bg-lcars-blue flex items-center justify-center px-4 text-sm font-medium text-lcars-bg uppercase tracking-wider hover:brightness-125 transition-all">
                    --:--:--
                </div>
                <div id="task-count" class="flex-1 bg-lcars-sky flex items-center justify-center px-4 text-sm font-medium text-lcars-bg uppercase tracking-wider hover:brightness-125 transition-all">
                    0 TASKS
                </div>
                <div id="uptime" class="flex-[2] bg-lcars-peach flex items-center justify-end px-4 text-sm font-medium text-lcars-bg uppercase tracking-wider rounded-bl-lcars hover:brightness-125 transition-all">
                    --
                </div>
                <div class="w-12 bg-lcars-orange rounded-bl-[50px]"></div>
            </div>
        </header>

        <!-- Sidebar: Crew by Department -->
        <aside class="lcars-sidebar row-span-2 flex flex-col pt-1 overflow-hidden">
            <div id="sidebar-crew" class="flex-1 flex flex-col gap-0.5 overflow-y-auto pr-1">
                <!-- Rendered by JS -->
            </div>
            <div class="flex gap-1 mt-1">
                <button onclick="openMessagesModal()" id="messages-btn" class="flex-1 bg-lcars-violet h-8 rounded-r-lg flex items-center justify-center text-xs font-bold text-lcars-bg uppercase cursor-pointer hover:brightness-125 transition-all">
                    MSG <span id="msg-badge" class="hidden bg-status-alert text-black text-xs font-bold px-1 rounded-xl ml-1 animate-pulse">0</span>
                </button>
            </div>
            <div class="sidebar-elbow-bottom bg-lcars-tan h-[30px] mt-1"></div>
        </aside>

        <!-- Stats Bar -->
        <div id="stats-bar" class="col-start-2 flex gap-3 p-3 pb-0 overflow-x-auto">
            <!-- Weather -->
            <div class="stat-card flex-shrink-0 min-w-[160px] bg-lcars-panel border-2 border-lcars-teal rounded-lcars-sm p-3 flex flex-col gap-1">
                <div class="text-xs uppercase tracking-wider text-lcars-violet flex items-center gap-1">
                    <span id="weather-icon">üå§Ô∏è</span> Brussels
                </div>
                <div id="stat-weather-temp" class="text-xl font-bold text-lcars-gold">--¬∞C</div>
                <div id="stat-weather-cond" class="text-xs text-lcars-tan truncate">Loading...</div>
            </div>
            <!-- System Health (CPU/Mem/Disk) -->
            <div class="stat-card flex-shrink-0 min-w-[180px] bg-lcars-panel border-2 border-lcars-sky rounded-lcars-sm p-3 flex flex-col gap-1">
                <div class="text-xs uppercase tracking-wider text-lcars-violet">System Health</div>
                <div class="flex items-center gap-2">
                    <div class="flex-1">
                        <div class="text-xs text-lcars-tan">CPU</div>
                        <div class="h-1.5 bg-white/10 rounded-sm overflow-hidden">
                            <div id="stat-cpu-bar" class="h-full bg-lcars-blue rounded-sm transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="stat-cpu" class="text-sm font-bold text-lcars-gold w-10 text-right">0%</div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="flex-1">
                        <div class="text-xs text-lcars-tan">MEM</div>
                        <div class="h-1.5 bg-white/10 rounded-sm overflow-hidden">
                            <div id="stat-mem-bar" class="h-full bg-lcars-purple rounded-sm transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="stat-mem" class="text-sm font-bold text-lcars-gold w-10 text-right">0%</div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="flex-1">
                        <div class="text-xs text-lcars-tan">DISK</div>
                        <div class="h-1.5 bg-white/10 rounded-sm overflow-hidden">
                            <div id="stat-disk-bar" class="h-full bg-lcars-orange rounded-sm transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="stat-disk" class="text-sm font-bold text-lcars-gold w-10 text-right">0%</div>
                </div>
            </div>
            <!-- Work Loop -->
            <div class="stat-card flex-shrink-0 min-w-[150px] bg-lcars-panel border-2 border-lcars-green rounded-lcars-sm p-3 flex flex-col gap-1">
                <div class="text-xs uppercase tracking-wider text-lcars-violet">Work Loop</div>
                <div class="flex items-baseline gap-1">
                    <span id="stat-workloop-status" class="text-xl font-bold text-lcars-gold">--</span>
                    <span id="stat-workloop-indicator" class="w-2 h-2 rounded-full bg-status-offline"></span>
                </div>
                <div id="stat-workloop-sub" class="text-xs text-lcars-tan">0 workers ‚Ä¢ 0 queued</div>
            </div>
            <!-- Sessions -->
            <div class="stat-card flex-shrink-0 min-w-[140px] bg-lcars-panel border-2 border-lcars-orange rounded-lcars-sm p-3 flex flex-col gap-1">
                <div class="text-xs uppercase tracking-wider text-lcars-violet">Sessions</div>
                <div id="stat-sessions" class="text-xl font-bold text-lcars-gold">0</div>
                <div id="stat-sessions-sub" class="text-xs text-lcars-tan">0 running</div>
            </div>
            <!-- Tasks -->
            <div class="stat-card flex-shrink-0 min-w-[140px] bg-lcars-panel border-2 border-lcars-blue rounded-lcars-sm p-3 flex flex-col gap-1">
                <div class="text-xs uppercase tracking-wider text-lcars-violet">Tasks</div>
                <div id="stat-tasks" class="text-xl font-bold text-lcars-gold">0</div>
                <div id="stat-tasks-sub" class="text-xs text-lcars-tan">0 active</div>
            </div>
            <!-- Uptime -->
            <div class="stat-card flex-shrink-0 min-w-[150px] bg-lcars-panel border-2 border-lcars-violet rounded-lcars-sm p-3 flex flex-col gap-1">
                <div class="text-xs uppercase tracking-wider text-lcars-violet">Uptime</div>
                <div class="flex items-center gap-2 text-xs">
                    <span class="text-lcars-tan">GW:</span>
                    <span id="stat-uptime-gw" class="font-bold text-lcars-gold">--</span>
                </div>
                <div class="flex items-center gap-2 text-xs">
                    <span class="text-lcars-tan">DASH:</span>
                    <span id="stat-uptime-dash" class="font-bold text-lcars-gold">--</span>
                </div>
            </div>
            <!-- P&L -->
            <div class="stat-card flex-shrink-0 min-w-[140px] bg-lcars-panel border-2 border-lcars-gold rounded-lcars-sm p-3 flex flex-col gap-1">
                <div class="text-xs uppercase tracking-wider text-lcars-violet">P&L</div>
                <div id="stat-pnl" class="text-xl font-bold text-lcars-gold">$0</div>
                <div id="stat-pnl-sub" class="text-xs text-lcars-tan">0 trades</div>
            </div>
        </div>

        <!-- Main Content - Two Panel Layout -->
        <main class="mission-content col-start-2 grid grid-cols-[1fr_340px] gap-3 p-3 overflow-hidden">
            
            <!-- Hidden container for compatibility -->
            <div id="agents-list" class="hidden"></div>
            <span id="total-tasks-badge" class="hidden"></span>

            <!-- Left Panel: Mission Queue (Kanban) -->
            <div class="mission-panel bg-lcars-panel border-2 border-lcars-blue rounded-lcars flex flex-col overflow-hidden">
                <div class="flex items-stretch h-[38px] flex-shrink-0">
                    <div class="w-[60px] bg-lcars-blue flex items-center justify-center text-xs font-bold text-lcars-bg uppercase tracking-wider">QUEUE</div>
                    <div class="flex-1 flex items-center justify-between px-3 bg-black/50">
                        <span class="text-sm font-bold tracking-widest uppercase text-lcars-blue">Mission Queue</span>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-2">
                    <div id="kanban-container" class="flex gap-2 h-full overflow-x-auto pb-2">
                        <!-- Kanban columns rendered here -->
                    </div>
                </div>
            </div>

            <!-- Right Panel: System Tasks + Live Feed -->
            <div class="feed-panel bg-lcars-panel border-2 border-lcars-orange rounded-lcars flex flex-col overflow-hidden">
                <div class="flex items-stretch h-[38px] flex-shrink-0">
                    <div class="w-[60px] bg-lcars-orange flex items-center justify-center text-xs font-bold text-lcars-bg uppercase tracking-wider">FEED</div>
                    <div class="flex-1 flex items-center justify-between px-3 bg-black/50">
                        <span class="text-sm font-bold tracking-widest uppercase text-lcars-orange">Activity</span>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto" style="padding: 0;">
                    <!-- System Tasks Section -->
                    <div id="system-tasks-section" class="bg-lcars-teal/10 border border-lcars-teal rounded-lcars-xs p-2 m-2 mb-0">
                        <div class="flex justify-between items-center mb-2 text-xs">
                            <span class="text-lcars-teal font-bold tracking-wider">‚óà SYSTEM TASKS</span>
                            <span id="system-count" class="text-status-active text-xs">0 ACTIVE</span>
                        </div>
                        <div id="system-tasks-list">
                            <!-- System tasks rendered here -->
                        </div>
                    </div>
                    
                    <!-- Feed Filters -->
                    <div id="feed-filters" class="flex flex-wrap gap-1 p-2 border-b border-white/10">
                        <button class="feed-filter active px-2 py-1 bg-lcars-orange text-black border border-lcars-orange rounded-xl text-xs font-semibold cursor-pointer transition-all" data-filter="all">All</button>
                        <button class="feed-filter px-2 py-1 bg-black/40 text-lcars-tan border border-lcars-tan rounded-xl text-xs font-semibold cursor-pointer transition-all hover:bg-lcars-orange/20" data-filter="task">Tasks</button>
                        <button class="feed-filter px-2 py-1 bg-black/40 text-lcars-teal border border-lcars-teal rounded-xl text-xs font-semibold cursor-pointer transition-all hover:bg-lcars-teal/30" data-filter="tool">Tools</button>
                        <button class="feed-filter px-2 py-1 bg-black/40 text-lcars-violet border border-lcars-violet rounded-xl text-xs font-semibold cursor-pointer transition-all hover:bg-lcars-violet/20" data-filter="thinking">Thinking</button>
                        <button class="feed-filter px-2 py-1 bg-black/40 text-lcars-tan border border-lcars-tan rounded-xl text-xs font-semibold cursor-pointer transition-all hover:bg-lcars-orange/20" data-filter="status">Status</button>
                    </div>
                    
                    <div id="feed-list" class="flex-1 overflow-y-auto p-2">
                        <!-- Feed items rendered here -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="col-span-2 flex items-stretch gap-1">
            <div id="footer-clients" class="footer-elbow w-40 bg-lcars-tan flex items-center justify-center text-xs font-bold text-lcars-bg">0 CLIENTS</div>
            <div class="flex-1 flex gap-1 pl-1">
                <div id="footer-status" class="flex-1 bg-lcars-purple flex items-center px-3 text-sm font-medium text-lcars-bg rounded-tl-lcars">ONLINE</div>
                <div id="footer-active" class="flex-1 bg-lcars-blue flex items-center px-3 text-sm font-medium text-lcars-bg">0 ACTIVE</div>
                <div id="footer-pending" class="flex-1 bg-lcars-sky flex items-center px-3 text-sm font-medium text-lcars-bg">0 PENDING</div>
                <div id="footer-update" class="flex-[2] bg-lcars-orange flex items-center px-3 text-sm font-medium text-lcars-bg">Last Update: --:--:--</div>
                <div id="footer-version" class="flex-1 bg-lcars-peach flex items-center px-3 text-sm font-medium text-lcars-bg rounded-bl-lcars">v7.0</div>
            </div>
        </footer>
    </div>

    <!-- Connection Status -->
    <div id="connection-status" class="fixed bottom-[60px] right-5 px-2.5 py-1.5 rounded-xl text-xs font-bold uppercase tracking-wider z-[100] flex items-center gap-1.5 backdrop-blur-xl bg-black/80 border border-status-alert text-status-alert">
        <div id="connection-dot" class="w-1.5 h-1.5 rounded-full bg-status-alert"></div>
        <span id="connection-text">DISCONNECTED</span>
    </div>

    <!-- Keyboard Shortcuts -->
    <div class="shortcuts-hint fixed bottom-[60px] left-[180px] px-3 py-1.5 bg-black/80 border border-lcars-tan rounded-lg text-xs text-lcars-gold z-[100] flex gap-3 backdrop-blur-xl">
        <div class="flex items-center gap-1"><kbd class="bg-lcars-tan text-black px-1 rounded-sm font-bold">N</kbd> New Task</div>
        <div class="flex items-center gap-1"><kbd class="bg-lcars-tan text-black px-1 rounded-sm font-bold">M</kbd> Messages</div>
        <div class="flex items-center gap-1"><kbd class="bg-lcars-tan text-black px-1 rounded-sm font-bold">T</kbd> Scanlines</div>
        <div class="flex items-center gap-1"><kbd class="bg-lcars-tan text-black px-1 rounded-sm font-bold">Esc</kbd> Close</div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed top-4 right-4 z-[1002] flex flex-col gap-2"></div>

    <!-- Task Detail Modal -->
    <div id="task-modal-overlay" class="fixed inset-0 bg-black/80 z-[1001] hidden items-center justify-center backdrop-blur-sm">
        <div class="task-modal w-[90%] max-w-[600px] max-h-[80vh] bg-lcars-panel border-2 border-lcars-orange rounded-lcars flex flex-col overflow-hidden">
            <div class="flex items-stretch h-[45px]">
                <div class="w-[70px] bg-lcars-orange flex items-center justify-center text-xs font-bold text-black">TASK</div>
                <div class="flex-1 flex items-center justify-between px-4 bg-black/50">
                    <div id="modal-task-title" class="text-base font-bold text-lcars-gold">Task Title</div>
                    <div class="flex items-center gap-2">
                        <button onclick="deleteCurrentTask()" id="delete-task-btn" class="bg-transparent border-none text-lcars-red text-xs cursor-pointer px-2 hover:text-lcars-orange hover:underline" title="Delete task">DELETE</button>
                        <button onclick="closeTaskModal()" class="bg-transparent border-none text-lcars-orange text-2xl cursor-pointer px-2 hover:text-lcars-gold">√ó</button>
                    </div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <div id="modal-task-meta" class="grid grid-cols-3 gap-3 mb-4 p-3 bg-black/30 rounded-lg"></div>
                <div class="mb-4">
                    <div class="text-xs font-bold uppercase tracking-wider text-lcars-tan mb-1">Description</div>
                    <div id="modal-task-desc" class="text-sm text-lcars-gold leading-relaxed">Task description...</div>
                </div>
                
                <!-- Tabs -->
                <div class="flex border-b border-white/10 mb-3">
                    <button class="task-modal-tab active flex-1 py-2 px-3 bg-transparent border-none text-lcars-orange font-bold text-sm uppercase tracking-wider cursor-pointer relative" data-tab="comments" onclick="switchTaskTab('comments')">
                        Comments <span id="comments-count" class="inline-flex items-center justify-center min-w-[16px] h-4 px-1 bg-lcars-orange text-black rounded-lg text-xs ml-1">0</span>
                    </button>
                    <button class="task-modal-tab flex-1 py-2 px-3 bg-transparent border-none text-lcars-tan font-bold text-sm uppercase tracking-wider cursor-pointer relative hover:text-lcars-orange" data-tab="activity" onclick="switchTaskTab('activity')">
                        Activity <span id="activity-count" class="inline-flex items-center justify-center min-w-[16px] h-4 px-1 bg-lcars-violet text-black rounded-lg text-xs ml-1">0</span>
                    </button>
                    <button class="task-modal-tab flex-1 py-2 px-3 bg-transparent border-none text-lcars-tan font-bold text-sm uppercase tracking-wider cursor-pointer relative hover:text-lcars-orange" data-tab="files" onclick="switchTaskTab('files')">
                        Files <span id="files-count" class="inline-flex items-center justify-center min-w-[16px] h-4 px-1 bg-lcars-sky text-black rounded-lg text-xs ml-1">0</span>
                    </button>
                </div>
                
                <div id="tab-comments" class="task-tab-content">
                    <div id="modal-task-comments" class="border-t border-white/10 pt-3"></div>
                    <div class="flex gap-2 mt-3">
                        <textarea id="comment-input" placeholder="Add a comment..." rows="2" class="flex-1 bg-black/40 border border-lcars-tan rounded-md p-2 text-lcars-gold font-lcars text-sm resize-none focus:outline-none focus:border-lcars-orange"></textarea>
                        <button onclick="addComment()" class="px-4 py-2 bg-lcars-orange border-none rounded-md text-black font-bold text-sm uppercase cursor-pointer hover:brightness-125 transition-all">Send</button>
                    </div>
                </div>
                
                <div id="tab-activity" class="task-tab-content hidden">
                    <div id="activity-log-list" class="max-h-[200px] overflow-y-auto">
                        <div class="text-center text-lcars-violet text-sm py-5">No activity logged yet</div>
                    </div>
                </div>
                
                <div id="tab-files" class="task-tab-content hidden">
                    <div id="files-list" class="max-h-[200px] overflow-y-auto">
                        <div class="text-center text-lcars-violet text-sm py-5">No files modified by this task</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="add-task-modal-overlay" class="fixed inset-0 bg-black/80 z-[1001] hidden items-center justify-center backdrop-blur-sm">
        <div class="task-modal w-[90%] max-w-[600px] max-h-[80vh] bg-lcars-panel border-2 border-lcars-green rounded-lcars flex flex-col overflow-hidden">
            <div class="flex items-stretch h-[45px]">
                <div class="w-[70px] bg-lcars-green flex items-center justify-center text-xs font-bold text-black">NEW</div>
                <div class="flex-1 flex items-center justify-between px-4 bg-black/50">
                    <div class="text-base font-bold text-lcars-green">Create New Task</div>
                    <button onclick="closeAddTaskModal()" class="bg-transparent border-none text-lcars-green text-2xl cursor-pointer px-2 hover:text-lcars-gold">√ó</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <form id="add-task-form" onsubmit="submitNewTask(event)">
                    <div class="mb-4">
                        <div class="text-xs font-bold uppercase tracking-wider text-lcars-tan mb-1">Title *</div>
                        <input type="text" id="new-task-title" placeholder="Task title..." required class="w-full mt-1 bg-black/40 border border-lcars-tan rounded-md p-2 text-lcars-gold font-lcars text-sm focus:outline-none focus:border-lcars-orange">
                    </div>
                    <div class="mb-4">
                        <div class="text-xs font-bold uppercase tracking-wider text-lcars-tan mb-1">Description</div>
                        <textarea id="new-task-desc" placeholder="Task description..." rows="3" class="w-full mt-1 bg-black/40 border border-lcars-tan rounded-md p-2 text-lcars-gold font-lcars text-sm resize-none focus:outline-none focus:border-lcars-orange"></textarea>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-4 p-3 bg-black/30 rounded-lg">
                        <div class="text-center">
                            <div class="text-xs font-bold uppercase tracking-wider text-lcars-tan mb-1">Assignee</div>
                            <select id="new-task-assignee" class="w-full p-1.5 mt-1 bg-black/40 border border-lcars-tan rounded-md text-lcars-gold font-lcars text-sm focus:outline-none focus:border-lcars-orange">
                                <option value="">Unassigned</option>
                                <option value="seven">Seven of Nine</option>
                                <option value="geordi">Geordi La Forge</option>
                                <option value="uhura">Nyota Uhura</option>
                                <option value="spock">Spock</option>
                                <option value="quark">Quark</option>
                            </select>
                        </div>
                        <div class="text-center">
                            <div class="text-xs font-bold uppercase tracking-wider text-lcars-tan mb-1">Priority</div>
                            <select id="new-task-priority" class="w-full p-1.5 mt-1 bg-black/40 border border-lcars-tan rounded-md text-lcars-gold font-lcars text-sm focus:outline-none focus:border-lcars-orange">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="text-center">
                            <div class="text-xs font-bold uppercase tracking-wider text-lcars-tan mb-1">Category</div>
                            <select id="new-task-category" class="w-full p-1.5 mt-1 bg-black/40 border border-lcars-tan rounded-md text-lcars-gold font-lcars text-sm focus:outline-none focus:border-lcars-orange">
                                <option value="general">General</option>
                                <option value="engineering">Engineering</option>
                                <option value="research">Research</option>
                                <option value="communications">Communications</option>
                                <option value="trading">Trading</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-2.5 justify-end mt-4">
                        <button type="button" onclick="closeAddTaskModal()" class="px-4 py-2 bg-lcars-tan border-none rounded-md text-black font-bold text-sm uppercase cursor-pointer hover:brightness-125 transition-all">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-lcars-green border-none rounded-md text-black font-bold text-sm uppercase cursor-pointer hover:brightness-125 transition-all">Create Task</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Messages Modal -->
    <div id="messages-modal" class="fixed inset-0 bg-black/85 z-[2000] hidden justify-center items-center">
        <div class="bg-[#0a0a12] border-[3px] border-lcars-violet rounded-lcars w-[90%] max-w-[800px] max-h-[80vh] flex flex-col overflow-hidden">
            <div class="flex items-stretch bg-lcars-violet text-black">
                <div class="w-[70px] rounded-br-lcars flex items-center justify-center font-bold text-sm">COMMS</div>
                <div class="flex-1 px-4 py-3 text-lg font-bold tracking-widest">CREW MESSAGES</div>
                <div onclick="closeMessagesModal()" class="w-12 bg-lcars-red flex items-center justify-center cursor-pointer text-lg font-bold rounded-bl-lcars hover:bg-red-400 transition-colors">‚úï</div>
            </div>
            <div class="flex flex-1 overflow-hidden">
                <div class="w-[150px] bg-[#0d0d15] border-r-2 border-lcars-violet flex flex-col gap-1 p-2">
                    <div class="messages-filter active px-3 py-2 bg-lcars-gold text-black font-bold text-xs rounded-lcars cursor-pointer text-center hover:brightness-125 transition-all" data-filter="all" onclick="filterMessages('all')">ALL</div>
                    <div class="messages-filter px-3 py-2 bg-lcars-gold text-black font-bold text-xs rounded-lcars cursor-pointer text-center hover:brightness-125 transition-all" data-filter="unread" onclick="filterMessages('unread')">UNREAD</div>
                    <hr class="border-lcars-violet my-2">
                    <div class="messages-filter px-3 py-2 bg-lcars-gold text-black font-bold text-xs rounded-lcars cursor-pointer text-center hover:brightness-125 transition-all" data-filter="seven" onclick="filterMessages('seven')">SEVEN</div>
                    <div class="messages-filter px-3 py-2 bg-lcars-gold text-black font-bold text-xs rounded-lcars cursor-pointer text-center hover:brightness-125 transition-all" data-filter="spock" onclick="filterMessages('spock')">SPOCK</div>
                    <div class="messages-filter px-3 py-2 bg-lcars-gold text-black font-bold text-xs rounded-lcars cursor-pointer text-center hover:brightness-125 transition-all" data-filter="geordi" onclick="filterMessages('geordi')">GEORDI</div>
                    <div class="messages-filter px-3 py-2 bg-lcars-gold text-black font-bold text-xs rounded-lcars cursor-pointer text-center hover:brightness-125 transition-all" data-filter="uhura" onclick="filterMessages('uhura')">UHURA</div>
                    <div class="messages-filter px-3 py-2 bg-lcars-gold text-black font-bold text-xs rounded-lcars cursor-pointer text-center hover:brightness-125 transition-all" data-filter="quark" onclick="filterMessages('quark')">QUARK</div>
                </div>
                <div id="messages-list" class="flex-1 overflow-y-auto p-3">
                    <div class="text-lcars-tan text-center py-8">Loading messages...</div>
                </div>
                <div id="message-detail" class="flex-1 hidden flex-col p-4 border-l-2 border-lcars-violet">
                    <div id="detail-subject" class="text-base font-bold text-lcars-gold mb-1.5">Select a message</div>
                    <div id="detail-meta" class="text-sm text-lcars-tan"></div>
                    <div id="detail-content" class="flex-1 p-3 bg-black/30 rounded-lcars my-3 overflow-y-auto leading-relaxed text-xs">Click a message to view details</div>
                    <div id="detail-actions" class="hidden gap-2">
                        <button onclick="ackMessage()" class="px-4 py-2 bg-lcars-green text-black border-none rounded-lcars font-bold text-sm cursor-pointer hover:brightness-125 transition-all">ACK</button>
                        <button onclick="createTaskFromMsg()" class="px-4 py-2 bg-lcars-orange text-black border-none rounded-lcars font-bold text-sm cursor-pointer hover:brightness-125 transition-all">TASK</button>
                        <button onclick="deleteCurrentMsg()" class="px-4 py-2 bg-lcars-red text-black border-none rounded-lcars font-bold text-sm cursor-pointer hover:brightness-125 transition-all">DELETE</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // LCARS Command Center v7.0 - Unified Dashboard + Mission Control
        // Tailwind CSS Edition with Authentic LCARS Colors
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        class CommandCenter {
            constructor() {
                this.ws = null;
                this.reconnectAttempts = 0;
                this.bridgeData = null;
                this.tasksData = null;
                this.sessionsData = null;
                this.selectedTaskId = null;
                this.activeFilter = 'all';
                
                this.columnLabels = {
                    'inbox': 'Inbox',
                    'assigned': 'Assigned',
                    'in_progress': 'In Progress',
                    'review': 'Review',
                    'peer_review': 'Peer Review',
                    'done': 'Done'
                };
                
                // Category to emoji mapping for task completions
                this.categoryEmojis = {
                    'engineering': 'üöÄ',
                    'communications': 'üì°',
                    'research': 'üìö',
                    'trading': 'üí∞',
                    'priority': '‚≠ê',
                    'default': '‚úÖ'
                };
                
                this.initStarfield();
                this.connect();
                this.startClock();
                this.setupEventListeners();
            }

            initStarfield() {
                const container = document.getElementById('starfield');
                for (let i = 0; i < 80; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 100 + '%';
                    star.style.setProperty('--duration', (2 + Math.random() * 4) + 's');
                    star.style.setProperty('--base-opacity', (0.2 + Math.random() * 0.5));
                    container.appendChild(star);
                }
            }

            setupEventListeners() {
                // Filter buttons
                document.querySelectorAll('.feed-filter').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.feed-filter').forEach(b => {
                            b.classList.remove('active', 'bg-lcars-orange', 'text-black');
                            b.classList.add('bg-black/40', 'text-lcars-tan');
                        });
                        e.target.classList.remove('bg-black/40', 'text-lcars-tan');
                        e.target.classList.add('active', 'bg-lcars-orange', 'text-black');
                        this.activeFilter = e.target.dataset.filter;
                        this.renderFeed();
                    });
                });

                // Close modals on overlay click
                ['task-modal-overlay', 'add-task-modal-overlay'].forEach(id => {
                    document.getElementById(id)?.addEventListener('click', (e) => {
                        if (e.target.id === id) {
                            id === 'task-modal-overlay' ? closeTaskModal() : closeAddTaskModal();
                        }
                    });
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) return;
                    
                    if (e.key === 'Escape') {
                        closeTaskModal();
                        closeAddTaskModal();
                        closeMessagesModal();
                    }
                    if (e.key.toLowerCase() === 'n') showAddTask();
                    if (e.key.toLowerCase() === 'm') openMessagesModal();
                    if (e.key.toLowerCase() === 't') {
                        const scanlines = document.querySelector('.scanlines');
                        scanlines.style.display = scanlines.style.display === 'none' ? 'block' : 'none';
                    }
                });
            }

            connect() {
                this.updateConnectionStatus('connecting');
                
                try {
                    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${wsProtocol}//${window.location.host}`;
                    this.ws = new WebSocket(wsUrl);
                    
                    this.ws.onopen = () => {
                        console.log('[LCARS] Connected');
                        this.reconnectAttempts = 0;
                        this.updateConnectionStatus('connected');
                        document.getElementById('footer-status').textContent = 'ONLINE';
                        this.ws.send(JSON.stringify({ type: 'get_tasks' }));
                        
                        // Fetch additional stats on connect
                        this.fetchWeather();
                        this.fetchSystemStats();
                        this.fetchWorkLoop();
                        
                        // Set up refresh intervals
                        this.startStatRefreshTimers();
                    };
                    
                    this.ws.onmessage = (event) => {
                        try {
                            const msg = JSON.parse(event.data);
                            this.handleMessage(msg);
                        } catch (e) {
                            console.error('[LCARS] Parse error:', e);
                        }
                    };
                    
                    this.ws.onclose = () => {
                        this.updateConnectionStatus('disconnected');
                        document.getElementById('footer-status').textContent = 'OFFLINE';
                        this.scheduleReconnect();
                    };
                    
                    this.ws.onerror = () => console.error('[LCARS] WebSocket error');
                } catch (e) {
                    console.error('[LCARS] Connection error:', e);
                    this.scheduleReconnect();
                }
            }

            scheduleReconnect() {
                if (this.reconnectAttempts >= 50) return;
                this.reconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(1.5, this.reconnectAttempts - 1), 30000);
                setTimeout(() => this.connect(), delay);
            }

            updateConnectionStatus(status) {
                const el = document.getElementById('connection-status');
                const dot = document.getElementById('connection-dot');
                const text = document.getElementById('connection-text');
                
                if (status === 'connected') {
                    el.classList.remove('border-status-alert', 'text-status-alert');
                    el.classList.add('border-status-active', 'text-status-active');
                    dot.classList.remove('bg-status-alert');
                    dot.classList.add('bg-status-active', 'animate-pulse');
                } else {
                    el.classList.remove('border-status-active', 'text-status-active');
                    el.classList.add('border-status-alert', 'text-status-alert');
                    dot.classList.remove('bg-status-active', 'animate-pulse');
                    dot.classList.add('bg-status-alert');
                }
                text.textContent = status.toUpperCase();
            }

            handleMessage(msg) {
                if (msg.type === 'init' || msg.type === 'update' || msg.type === 'trade_update') {
                    this.bridgeData = msg.data;
                    // Fetch sessions from dedicated API endpoint (don't overwrite with zeros)
                    this.fetchSessions();
                    this.render();
                }
                if (msg.type === 'tasks' || msg.type === 'tasks_update') {
                    this.tasksData = msg.data;
                    this.render();
                }
                if (msg.type === 'messages' || msg.type === 'messages_update') {
                    window.crewMessages = msg.data?.messages || [];
                    window.messageCounts = msg.counts || {};
                    updateMessageBadge();
                    if (document.getElementById('messages-modal').classList.contains('flex')) {
                        renderMessageList();
                    }
                }
                // Handle task completion notifications (QC approval by Data)
                if (msg.type === 'task_completed' && msg.data) {
                    this.showTaskCompletedToast(msg.data);
                }
            }

            showTaskCompletedToast(data) {
                const category = data.category || 'default';
                const emoji = this.categoryEmojis[category] || this.categoryEmojis.default;
                const message = `QC Approved by Data`;
                const title = data.title || 'Task Completed';
                const container = document.getElementById('toast-container');
                
                const toast = document.createElement('div');
                toast.className = `toast ${category}`;
                toast.innerHTML = `
                    <span class="toast-icon">${emoji}</span>
                    <div class="toast-content">
                        <div class="toast-title">${this.escapeHtml(title)}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close" onclick="this.parentElement.classList.add('toast-exit'); setTimeout(() => this.parentElement.remove(), 300);">√ó</button>
                `;
                
                container.appendChild(toast);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.classList.add('toast-exit');
                        setTimeout(() => toast.remove(), 300);
                    }
                }, 5000);
                
                // Play a subtle notification sound (optional)
                this.playNotificationSound();
            }

            playNotificationSound() {
                // Create a subtle notification chime using Web Audio API
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // A5
                    oscillator.frequency.exponentialRampToValueAtTime(440, audioContext.currentTime + 0.15);
                    
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.15);
                } catch (e) {
                    // Audio not available, silently fail
                }
            }

            render() {
                this.renderStatsBar();
                this.renderSessions();
                this.renderAgents();
                this.renderKanban();
                this.renderSystemTasks();
                this.renderFeed();
                this.updateFooter();
            }

            startStatRefreshTimers() {
                // Clear existing timers
                if (this.weatherTimer) clearInterval(this.weatherTimer);
                if (this.systemTimer) clearInterval(this.systemTimer);
                if (this.workLoopTimer) clearInterval(this.workLoopTimer);
                
                // Weather: refresh every 30 minutes
                this.weatherTimer = setInterval(() => this.fetchWeather(), 30 * 60 * 1000);
                
                // System stats: refresh every 60 seconds
                this.systemTimer = setInterval(() => this.fetchSystemStats(), 60 * 1000);
                
                // Work loop: refresh every 30 seconds
                this.workLoopTimer = setInterval(() => this.fetchWorkLoop(), 30 * 1000);
            }

            async fetchSessions() {
                try {
                    const res = await fetch('/api/sessions');
                    if (res.ok) {
                        this.sessionsData = await res.json();
                        this.renderSessions();
                    }
                } catch (e) {
                    console.log('Sessions fetch failed:', e.message);
                }
            }

            async fetchTasks() {
                try {
                    const res = await fetch('/api/tasks');
                    if (res.ok) {
                        this.tasksData = await res.json();
                        this.render(); // Full render to update all components including activity logs
                    }
                } catch (e) {
                    console.log('Tasks fetch failed:', e.message);
                }
            }

            async fetchWeather() {
                try {
                    const res = await fetch('/api/weather');
                    if (res.ok) {
                        this.weatherData = await res.json();
                        this.renderWeather();
                    }
                } catch (e) {
                    console.log('Weather fetch failed:', e.message);
                }
            }

            async fetchSystemStats() {
                try {
                    const res = await fetch('/api/system');
                    if (res.ok) {
                        this.systemData = await res.json();
                        this.renderSystemStats();
                    }
                } catch (e) {
                    console.log('System stats fetch failed:', e.message);
                }
            }

            async fetchWorkLoop() {
                try {
                    const res = await fetch('/api/work-loop');
                    if (res.ok) {
                        this.workLoopData = await res.json();
                        this.renderWorkLoop();
                    }
                } catch (e) {
                    console.log('Work-loop fetch failed:', e.message);
                }
            }

            renderWeather() {
                if (!this.weatherData) return;
                const w = this.weatherData;
                
                document.getElementById('weather-icon').textContent = w.icon || 'üå§Ô∏è';
                document.getElementById('stat-weather-temp').textContent = `${w.temp_c}¬∞C`;
                document.getElementById('stat-weather-cond').textContent = w.condition || '--';
                document.getElementById('stat-weather-cond').title = `Feels like ${w.feels_like_c}¬∞C ‚Ä¢ ${w.humidity}% humidity ‚Ä¢ ${w.wind_kph} km/h ${w.wind_dir}`;
            }

            renderSystemStats() {
                if (!this.systemData) return;
                const s = this.systemData;
                
                // Disk stats
                const diskEl = document.getElementById('stat-disk');
                const diskBar = document.getElementById('stat-disk-bar');
                if (diskEl && diskBar) {
                    const disk = s.disk?.percent || 0;
                    diskEl.textContent = `${disk}%`;
                    diskBar.style.width = `${disk}%`;
                    diskBar.className = `h-full rounded-sm transition-all duration-500 ${disk > 90 ? 'bg-status-alert' : disk > 75 ? 'bg-lcars-orange' : 'bg-lcars-orange'}`;
                }
                
                // Uptime stats
                const gwEl = document.getElementById('stat-uptime-gw');
                const dashEl = document.getElementById('stat-uptime-dash');
                if (gwEl) gwEl.textContent = s.uptime?.gateway || '--';
                if (dashEl) dashEl.textContent = s.uptime?.dashboard || '--';
            }

            renderWorkLoop() {
                if (!this.workLoopData) return;
                const wl = this.workLoopData;
                
                const statusEl = document.getElementById('stat-workloop-status');
                const indicatorEl = document.getElementById('stat-workloop-indicator');
                const subEl = document.getElementById('stat-workloop-sub');
                
                if (statusEl) {
                    const isRunning = wl.status === 'running';
                    statusEl.textContent = isRunning ? (wl.stats?.cycleCount || 0) : 'OFF';
                    if (indicatorEl) {
                        indicatorEl.className = `w-2 h-2 rounded-full ${isRunning ? 'bg-status-active animate-pulse' : 'bg-status-offline'}`;
                    }
                }
                
                if (subEl) {
                    const workers = wl.activeWorkers ? Object.keys(wl.activeWorkers).length : 0;
                    const queued = wl.queue?.length || 0;
                    subEl.textContent = `${workers} workers ‚Ä¢ ${queued} queued`;
                }
            }

            renderSessions() {
                if (!this.sessionsData) return;
                
                // Update sessions tile
                const el = document.getElementById('stat-sessions');
                const sub = document.getElementById('stat-sessions-sub');
                if (el) el.textContent = this.sessionsData.total || 0;
                if (sub) sub.textContent = `${this.sessionsData.activeSubagents || 0} agents, ${this.sessionsData.runningCrons || 0} crons`;
            }

            renderStatsBar() {
                if (!this.bridgeData) return;
                const { system, crew } = this.bridgeData;
                
                // CPU
                const cpu = system?.cpuUsage || 0;
                document.getElementById('stat-cpu').textContent = `${cpu.toFixed(1)}%`;
                const cpuBar = document.getElementById('stat-cpu-bar');
                cpuBar.style.width = `${Math.min(100, cpu)}%`;
                cpuBar.className = `h-full rounded-sm transition-all duration-500 ${cpu > 80 ? 'bg-status-alert' : cpu > 60 ? 'bg-lcars-orange' : 'bg-lcars-blue'}`;
                
                // Memory
                const mem = system?.memPercent || 0;
                document.getElementById('stat-mem').textContent = `${mem.toFixed(1)}%`;
                const memBar = document.getElementById('stat-mem-bar');
                memBar.style.width = `${mem}%`;
                memBar.className = `h-full rounded-sm transition-all duration-500 ${mem > 85 ? 'bg-status-alert' : mem > 70 ? 'bg-lcars-orange' : 'bg-lcars-purple'}`;
                
                // Disk (from bridgeData fallback)
                const disk = system?.diskPercent || 0;
                const diskEl = document.getElementById('stat-disk');
                const diskBar = document.getElementById('stat-disk-bar');
                if (diskEl && diskBar && !this.systemData) {
                    diskEl.textContent = `${disk}%`;
                    diskBar.style.width = `${disk}%`;
                    diskBar.className = `h-full rounded-sm transition-all duration-500 ${disk > 90 ? 'bg-status-alert' : disk > 75 ? 'bg-lcars-orange' : 'bg-lcars-orange'}`;
                }
                
                // Sessions (from API)
                if (this.sessionsData) {
                    document.getElementById('stat-sessions').textContent = this.sessionsData.total || 0;
                    document.getElementById('stat-sessions-sub').textContent = `${this.sessionsData.activeSubagents || 0} agents, ${this.sessionsData.runningCrons || 0} crons`;
                }
                
                // Tasks
                const tasks = this.tasksData?.tasks || [];
                const active = tasks.filter(t => t.status === 'in_progress').length;
                document.getElementById('stat-tasks').textContent = tasks.length;
                document.getElementById('stat-tasks-sub').textContent = `${active} active`;
                
                // Trading P&L
                const quark = crew?.quark || {};
                const pnl = quark.pnl || 0;
                const pnlEl = document.getElementById('stat-pnl');
                pnlEl.textContent = `${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}`;
                pnlEl.className = `text-xl font-bold ${pnl >= 0 ? 'text-status-active' : 'text-status-alert'}`;
                document.getElementById('stat-pnl-sub').textContent = `${quark.trades || 0} trades`;
                
                // Uptime (header bar)
                document.getElementById('uptime').textContent = system?.uptime || '--';
                
                // Render additional stats if available
                this.renderWeather();
                this.renderSystemStats();
                this.renderWorkLoop();
            }

            // Platform mappings for each agent
            agentPlatforms = {
                seven: ['telegram', 'cli'],
                geordi: ['github', 'cli'],
                uhura: ['telegram', 'gmail', 'moltbook'],
                quark: ['polymarket', 'telegram'],
                spock: ['moltbook', 'research'],
                data: ['qc', 'review']
            };

            getAgentStatus(key) {
                // PRIORITY 1: Check work-loop active workers (most reliable source)
                const workLoop = this.workLoopData;
                const activeWorkers = workLoop?.activeWorkers || {};
                if (activeWorkers[key] && activeWorkers[key].taskId) {
                    // Agent is actively processing in work-loop
                    const complexity = activeWorkers[key].complexity;
                    if (complexity === 'qc-review' || key === 'data') return 'thinking';
                    if (key === 'spock') return 'researching';
                    return 'building';
                }
                
                // PRIORITY 2: Check bridge data for crew status (includes work-loop task info)
                const crew = this.bridgeData?.crew?.[key];
                const crewStatus = crew?.status?.toUpperCase();
                const workLoopTask = crew?.workLoopTask;
                
                // If bridge data shows work-loop task, agent is active
                if (workLoopTask && workLoopTask.taskId) {
                    if (workLoopTask.complexity === 'qc-review' || key === 'data') return 'thinking';
                    if (key === 'spock') return 'researching';
                    return 'building';
                }
                
                // Check for active sessions (sub-agents)
                const hasActiveSubagent = this.sessionsData?.subagents?.some(s => 
                    s.label?.toLowerCase().includes(key) || s.session?.includes(key) || s.crew === key
                );
                
                // Check if agent has active tasks
                const activeTasks = (this.tasksData?.tasks || []).filter(t => t.assignee === key && t.status === 'in_progress');
                const hasActiveTasks = activeTasks.length > 0;
                
                // Check for recent activity logs to determine state
                const recentLogs = [];
                (this.tasksData?.tasks || []).forEach(t => {
                    if (t.assignee === key && t.logs?.length > 0) {
                        const recent = t.logs.filter(l => {
                            const logTime = new Date(l.timestamp).getTime();
                            return Date.now() - logTime < 300000; // Last 5 minutes
                        });
                        recentLogs.push(...recent);
                    }
                });
                
                // Check for activity feed entries
                const recentActivity = (this.tasksData?.activity || []).filter(a => {
                    if (a.agent !== key) return false;
                    const actTime = new Date(a.timestamp).getTime();
                    return Date.now() - actTime < 300000;
                });
                
                // Determine nuanced state
                if (crewStatus === 'OFFLINE') return 'offline';
                
                // If has sub-agents running, it's BUILDING
                if (hasActiveSubagent) return 'building';
                
                // Check recent logs for state hints
                const logTypes = recentLogs.map(l => l.type?.toLowerCase() || l.message?.toLowerCase() || '');
                const activityTypes = recentActivity.map(a => a.action?.toLowerCase() || '');
                const allActivity = [...logTypes, ...activityTypes].join(' ');
                
                if (allActivity.includes('search') || allActivity.includes('research') || allActivity.includes('web') || allActivity.includes('fetch')) {
                    return 'researching';
                }
                if (allActivity.includes('think') || allActivity.includes('plan') || allActivity.includes('evaluat') || allActivity.includes('review')) {
                    return 'thinking';
                }
                if (allActivity.includes('wait') || allActivity.includes('blocked') || allActivity.includes('pending')) {
                    return 'waiting';
                }
                if (allActivity.includes('build') || allActivity.includes('creat') || allActivity.includes('writ') || allActivity.includes('edit')) {
                    return 'building';
                }
                
                // Fallback to crew status from bridge data
                if (['ACTIVE', 'BUILDING', 'PROCESSING'].includes(crewStatus)) return 'building';
                if (['RESEARCHING', 'SEARCHING'].includes(crewStatus)) return 'researching';
                if (['REVIEWING'].includes(crewStatus)) return 'thinking';
                if (['TRADING', 'MONITORING'].includes(crewStatus)) return 'building';
                if (crewStatus === 'WAITING') return 'waiting';
                
                // If has active tasks but no recent activity, assume working
                if (hasActiveTasks) return 'building';
                
                return 'idle';
            }

            getAgentTaskCount(key) {
                // Regular assigned tasks
                const assignedTasks = (this.tasksData?.tasks || []).filter(t => t.assignee === key && t.status !== 'done').length;
                
                // For Data (QC), also count pending review tasks
                if (key === 'data') {
                    const pendingReviews = this.bridgeData?.crew?.data?.pendingReviews || 0;
                    return assignedTasks + pendingReviews;
                }
                
                // Check if agent has active work-loop task
                const workLoopTask = this.bridgeData?.crew?.[key]?.workLoopTask;
                if (workLoopTask && workLoopTask.taskId && assignedTasks === 0) {
                    return 1; // At least 1 task if work-loop shows active
                }
                
                return assignedTasks;
            }

            renderAgents() {
                const container = document.getElementById('sidebar-crew');
                if (!container || !this.tasksData?.agents) return;

                const agents = this.tasksData.agents;
                
                // Department config with LCARS colors
                const depts = [
                    { id: 'CMD', name: 'CMD', color: '#cc99cc' },
                    { id: 'ENG', name: 'ENG', color: '#9999ff' },
                    { id: 'COM', name: 'COM', color: '#cc6699' },
                    { id: 'SCI', name: 'SCI', color: '#99cc99' },
                    { id: 'TRD', name: 'TRD', color: '#ffcc99' },
                    { id: 'QC', name: 'QC', color: '#ffd700' }
                ];
                
                // Group agents by department
                const grouped = {};
                Object.entries(agents).forEach(([key, agent]) => {
                    const dept = agent.department || 'OTHER';
                    if (!grouped[dept]) grouped[dept] = [];
                    grouped[dept].push({ key, ...agent });
                });
                
                // Status indicators
                const getStatus = (key) => {
                    const status = this.getAgentStatus(key);
                    const active = ['thinking', 'building', 'researching', 'reviewing'].includes(status);
                    return active ? '‚óè' : '‚óã';
                };
                const getStatusColor = (key) => {
                    const status = this.getAgentStatus(key);
                    const colors = { thinking: '#99ccff', building: '#99ff99', researching: '#ffcc66', reviewing: '#cc99cc' };
                    return colors[status] || '#666';
                };
                
                let html = depts.filter(d => grouped[d.id]).map(dept => {
                    const deptAgents = grouped[dept.id];
                    
                    // Department header as LCARS button
                    const header = `<div class="bg-[${dept.color}] h-7 rounded-r-lg flex items-center px-2 text-xs font-bold text-lcars-bg uppercase tracking-wider mb-0.5">${dept.name}</div>`;
                    
                    // Agent rows
                    const rows = deptAgents.map(agent => {
                        const taskCount = this.getAgentTaskCount(agent.key);
                        const statusDot = getStatus(agent.key);
                        const statusColor = getStatusColor(agent.key);
                        const firstName = agent.name.split(' ')[0];
                        const modelLetter = agent.model ? agent.model[0].toUpperCase() : '';
                        const modelColors = { O: '#9b59b6', C: '#27ae60', M: '#3498db' };
                        
                        return `
                            <div class="flex items-center gap-1 py-0.5 px-2 cursor-pointer hover:bg-white/10 rounded-r transition-all" data-agent="${agent.key}">
                                <span style="color: ${statusColor}">${statusDot}</span>
                                <span class="text-xs text-lcars-gold flex-1 truncate font-medium">${firstName}</span>
                                ${modelLetter ? `<span class="w-4 h-4 rounded text-[9px] font-bold flex items-center justify-center text-white" style="background: ${modelColors[modelLetter]}">${modelLetter}</span>` : ''}
                                ${taskCount > 0 ? `<span class="text-[10px] text-lcars-sky font-bold">${taskCount}</span>` : ''}
                            </div>
                        `;
                    }).join('');
                    
                    return header + rows;
                }).join('');
                
                // Active sessions indicator
                if (this.sessionsData && (this.sessionsData.activeSubagents > 0 || this.sessionsData.runningCrons > 0)) {
                    html += `
                        <div class="bg-lcars-orange h-6 rounded-r-lg flex items-center justify-between px-2 text-[10px] font-bold text-lcars-bg uppercase mt-1">
                            <span>ACTIVE</span>
                            <span>${this.sessionsData.activeSubagents}A ${this.sessionsData.runningCrons}C</span>
                        </div>`;
                }
                
                container.innerHTML = html;
            }

            renderKanban() {
                const container = document.getElementById('kanban-container');
                if (!this.tasksData?.tasks) {
                    container.innerHTML = '<div class="text-lcars-violet text-center py-8">Loading tasks...</div>';
                    return;
                }

                const columns = this.tasksData.columns || ['inbox', 'assigned', 'in_progress', 'review', 'peer_review', 'done'];
                const tasks = this.tasksData.tasks;
                const agents = this.tasksData.agents || {};

                const columnColors = {
                    'inbox': 'text-lcars-violet',
                    'assigned': 'text-lcars-sky',
                    'in_progress': 'text-lcars-blue',
                    'review': 'text-lcars-orange',
                    'peer_review': 'text-lcars-gold',
                    'done': 'text-lcars-green'
                };

                container.innerHTML = columns.map(status => {
                    const columnTasks = tasks.filter(t => t.status === status);
                    return `
                        <div class="kanban-column min-w-[160px] flex-1 bg-black/30 rounded-lcars-xs flex flex-col overflow-hidden" data-status="${status}" 
                             ondragover="event.preventDefault()" 
                             ondrop="cc.dropTask(event, '${status}')">
                            <div class="px-2.5 py-2 flex items-center justify-between border-b-2 border-lcars-tan">
                                <span class="text-xs font-bold uppercase tracking-wider ${columnColors[status]}">${this.columnLabels[status] || status}</span>
                                <span class="bg-lcars-tan text-black px-1.5 py-0.5 rounded-lg text-xs font-bold">${columnTasks.length}</span>
                            </div>
                            <div class="flex-1 overflow-y-auto p-1.5">
                                ${columnTasks.map(t => this.renderTaskCard(t, agents)).join('')}
                                ${status === 'inbox' ? '<button class="w-full p-1.5 bg-lcars-orange/10 border border-dashed border-lcars-tan rounded-md text-lcars-tan font-lcars text-xs cursor-pointer transition-all hover:bg-lcars-orange/20 hover:border-lcars-orange hover:text-lcars-orange" onclick="showAddTask()">+ Add</button>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('task-count').textContent = `${tasks.length} TASKS`;
            }

            renderTaskCard(task, agents) {
                const agent = task.assignee ? agents[task.assignee] : null;
                const priorityColors = {
                    high: 'bg-status-alert',
                    medium: 'bg-status-warning',
                    low: 'bg-lcars-violet'
                };
                
                // File badges for tasks with modified files
                const fileCount = task.fileCount || (task.files ? task.files.length : 0);
                const hasLockedFiles = task.files && task.files.some(f => f.locked);
                const fileBadge = fileCount > 0 ? `
                    <div class="flex items-center gap-0.5 px-1 py-0.5 rounded-sm text-xs ${hasLockedFiles ? 'bg-status-alert/30 text-status-alert' : 'bg-lcars-sky/20 text-lcars-sky'}" title="${task.files ? task.files.map(f => f.name + (f.locked ? ' üîí' : '')).join(', ') : ''}">
                        ${hasLockedFiles ? 'üîí' : 'üìÑ'} ${fileCount}
                    </div>
                ` : '';
                
                return `
                    <div class="task-card bg-lcars-panel border border-lcars-tan rounded-lg p-2 mb-1.5 cursor-pointer transition-all relative hover:-translate-y-0.5 hover:shadow-[0_4px_15px_rgba(255,153,0,0.2)]" data-task-id="${task.id}"
                         draggable="true"
                         ondragstart="cc.dragTask(event, '${task.id}')"
                         onclick="cc.openTask('${task.id}')">
                        <div class="absolute top-0 left-0 w-[3px] h-full rounded-l-lg ${priorityColors[task.priority] || priorityColors.medium}"></div>
                        <div class="flex items-center justify-between mb-1 pl-1.5">
                            <div class="text-sm font-semibold text-lcars-gold flex-1">${this.escapeHtml(task.title)}</div>
                            ${fileBadge}
                        </div>
                        <div class="text-xs text-lcars-violet mb-1.5 pl-1.5 line-clamp-2">${this.escapeHtml(task.description || '')}</div>
                        <div class="flex items-center justify-between pl-1.5">
                            ${agent ? `
                                <div class="flex items-center gap-1">
                                    <div class="w-4 h-4 rounded-sm flex items-center justify-center text-sm font-bold text-black" style="background: ${agent.color}">${agent.department}</div>
                                    <span class="text-xs text-lcars-sky">${agent.name.split(' ')[0]}</span>
                                </div>
                            ` : '<span></span>'}
                            <span class="px-1.5 py-0.5 rounded-sm text-xs font-bold uppercase bg-lcars-blue/20 text-lcars-blue">${task.category || 'general'}</span>
                        </div>
                    </div>
                `;
            }

            async renderSystemTasks() {
                const container = document.getElementById('system-tasks-list');
                const countEl = document.getElementById('system-count');
                
                // Fetch cron jobs from API
                let cronJobs = [];
                try {
                    const res = await fetch('/api/cron');
                    const data = await res.json();
                    cronJobs = data.jobs || [];
                } catch (e) {
                    console.error('Failed to fetch cron jobs:', e);
                }

                // Map cron jobs to display format
                const systemTasks = cronJobs.filter(j => j.enabled).map(job => {
                    let agent = 'seven';
                    let type = 'monitoring';
                    
                    // Determine agent based on job name
                    if (job.name.includes('email') || job.name.includes('gmail')) {
                        agent = 'uhura';
                        type = 'communications';
                    } else if (job.name.includes('quark') || job.name.includes('trading')) {
                        agent = 'quark';
                        type = 'trading';
                    } else if (job.name.includes('git') || job.name.includes('qmd')) {
                        agent = 'geordi';
                        type = 'engineering';
                    }
                    
                    // Determine status
                    let taskStatus = 'idle';
                    let statusColor = 'bg-lcars-violet';
                    
                    if (job.lastStatus === 'ok') {
                        taskStatus = 'active';
                        statusColor = 'bg-status-active';
                    } else if (job.lastStatus === 'running') {
                        taskStatus = 'running';
                        statusColor = 'bg-status-active animate-pulse';
                    } else if (job.lastStatus === 'error') {
                        taskStatus = 'error';
                        statusColor = 'bg-status-alert';
                    }
                    
                    // Format name
                    const displayName = job.name.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    
                    return {
                        name: displayName,
                        agent,
                        type,
                        taskStatus,
                        statusColor,
                        nextRun: job.nextRunIn || '--',
                        lastRun: job.lastRunAgo || '--'
                    };
                });

                // Also add work-loop status
                try {
                    const wlRes = await fetch('/api/work-loop');
                    const wlData = await wlRes.json();
                    systemTasks.unshift({
                        name: 'Work Loop',
                        agent: 'seven',
                        type: 'coordination',
                        taskStatus: wlData.status === 'running' ? 'active' : 'idle',
                        statusColor: wlData.status === 'running' ? 'bg-status-active animate-pulse' : 'bg-lcars-violet',
                        nextRun: `${wlData.queue?.length || 0} queued`,
                        lastRun: `${wlData.stats?.cycleCount || 0} cycles`
                    });
                } catch (e) {}

                const active = systemTasks.filter(t => t.taskStatus === 'active' || t.taskStatus === 'running').length;
                if (countEl) countEl.textContent = `${active}/${systemTasks.length} ACTIVE`;

                container.innerHTML = systemTasks.map(t => `
                    <div class="flex items-center gap-2 py-1.5 border-b border-white/5 last:border-0 text-xs">
                        <div class="w-1.5 h-1.5 rounded-full ${t.statusColor}"></div>
                        <span class="flex-1 text-lcars-white truncate" title="${t.name}">${t.name}</span>
                        <span class="text-sm text-lcars-sky">${t.nextRun}</span>
                        <span class="text-lcars-teal text-xs uppercase">${t.agent}</span>
                    </div>
                `).join('');
            }

            renderFeed() {
                const container = document.getElementById('feed-list');
                if (!this.tasksData?.activity) {
                    container.innerHTML = '<div class="text-lcars-violet text-center py-5">No activity</div>';
                    return;
                }

                const agents = this.tasksData.agents || {};
                let activity = [...this.tasksData.activity].reverse();
                
                if (this.activeFilter !== 'all') {
                    activity = activity.filter(a => a.type === this.activeFilter);
                }

                const typeBorders = {
                    task: 'border-l-lcars-blue',
                    comment: 'border-l-lcars-green',
                    decision: 'border-l-lcars-purple',
                    status: 'border-l-lcars-orange',
                    tool: 'border-l-lcars-teal',
                    thinking: 'border-l-lcars-violet',
                    building: 'border-l-lcars-green',
                    research: 'border-l-lcars-peach'
                };

                container.innerHTML = activity.slice(0, 20).map((item, idx) => {
                    const agent = agents[item.agent] || { name: item.agent, color: '#666', department: '?' };
                    const feedId = `feed-${idx}`;
                    const hasDetails = item.toolName || item.toolArgs || item.payload || item.result || item.details;
                    
                    let actionText = '';
                    switch (item.action) {
                        case 'created': actionText = `created <strong class="text-lcars-gold">${this.escapeHtml(item.taskTitle || '')}</strong>`; break;
                        case 'assigned': actionText = `assigned to <strong class="text-lcars-gold">${agents[item.target]?.name || item.target}</strong>`; break;
                        case 'added': actionText = 'added a comment'; break;
                        case 'moved': actionText = `moved to <strong class="text-lcars-gold">${item.to || ''}</strong>`; break;
                        case 'completed': actionText = `completed <strong class="text-lcars-gold">${this.escapeHtml(item.taskTitle || '')}</strong>`; break;
                        case 'tool_call': actionText = `called <strong class="text-lcars-teal">${this.escapeHtml(item.toolName || 'tool')}</strong>`; break;
                        case 'thinking': actionText = `thinking: <em class="text-lcars-violet">${this.escapeHtml(item.thought || '')}</em>`; break;
                        case 'researching': actionText = `researching: <strong class="text-lcars-peach">${this.escapeHtml(item.query || item.topic || '')}</strong>`; break;
                        default: actionText = item.action || item.message || 'activity';
                    }
                    
                    // Build details section for expandable view
                    let detailsHtml = '';
                    if (hasDetails) {
                        const detailsContent = [];
                        if (item.toolName) {
                            detailsContent.push(`<div class="mb-2"><span class="text-lcars-teal text-xs font-bold">TOOL:</span> <span class="text-lcars-gold font-mono">${this.escapeHtml(item.toolName)}</span></div>`);
                        }
                        if (item.toolArgs) {
                            const argsStr = typeof item.toolArgs === 'object' ? JSON.stringify(item.toolArgs, null, 2) : item.toolArgs;
                            detailsContent.push(`<div class="mb-2"><span class="text-lcars-teal text-xs font-bold">ARGS:</span><pre class="text-lcars-sky text-xs font-mono mt-1 whitespace-pre-wrap break-all bg-black/30 p-2 rounded max-h-[100px] overflow-y-auto">${this.escapeHtml(argsStr)}</pre></div>`);
                        }
                        if (item.result) {
                            const resultStr = typeof item.result === 'object' ? JSON.stringify(item.result, null, 2) : String(item.result);
                            const truncated = resultStr.length > 300 ? resultStr.substring(0, 300) + '...' : resultStr;
                            detailsContent.push(`<div><span class="text-lcars-teal text-xs font-bold">RESULT:</span><pre class="text-lcars-green text-xs font-mono mt-1 whitespace-pre-wrap break-all bg-black/30 p-2 rounded max-h-[80px] overflow-y-auto">${this.escapeHtml(truncated)}</pre></div>`);
                        }
                        detailsHtml = `<div class="activity-details">${detailsContent.join('')}</div>`;
                    }
                    
                    return `
                        <div class="activity-entry flex flex-col gap-0 p-2 bg-black/30 rounded-lg mb-1.5 transition-all hover:bg-black/50 border-l-[3px] ${typeBorders[item.type] || 'border-l-lcars-tan'}" 
                             data-type="${item.type}" 
                             data-feed-id="${feedId}"
                             onclick="${hasDetails ? `cc.toggleFeedDetails('${feedId}')` : ''}">
                            <div class="flex gap-2">
                                <div class="w-7 h-7 rounded-md flex items-center justify-center text-xs font-bold text-black flex-shrink-0" style="background: ${agent.color}">${agent.department}</div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between mb-0.5">
                                        <span class="text-xs font-bold text-lcars-gold">${agent.name}</span>
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm text-lcars-violet">${this.formatTimeAgo(item.timestamp)}</span>
                                            ${hasDetails ? '<span class="activity-expand-icon text-lcars-orange">‚ñ∂</span>' : ''}
                                        </div>
                                    </div>
                                    <div class="text-xs text-lcars-sky">
                                        ${actionText}
                                        ${hasDetails ? '<span class="text-sm text-lcars-tan ml-1">[details]</span>' : ''}
                                    </div>
                                </div>
                            </div>
                            ${detailsHtml}
                        </div>
                    `;
                }).join('');
            }

            toggleFeedDetails(feedId) {
                const entry = document.querySelector(`[data-feed-id="${feedId}"]`);
                if (entry) {
                    entry.classList.toggle('expanded');
                }
            }

            updateFooter() {
                const tasks = this.tasksData?.tasks || [];
                const active = tasks.filter(t => t.status === 'in_progress').length;
                const pending = tasks.filter(t => ['inbox', 'assigned'].includes(t.status)).length;
                
                document.getElementById('footer-active').textContent = `${active} ACTIVE`;
                document.getElementById('footer-pending').textContent = `${pending} PENDING`;
                document.getElementById('footer-update').textContent = `Update: ${new Date().toLocaleTimeString()}`;
            }

            // Drag & Drop
            dragTask(event, taskId) {
                event.dataTransfer.setData('text/plain', taskId);
                event.target.classList.add('dragging');
            }

            dropTask(event, newStatus) {
                event.preventDefault();
                const taskId = event.dataTransfer.getData('text/plain');
                document.querySelector('.task-card.dragging')?.classList.remove('dragging');
                
                if (this.ws?.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type: 'update_task', taskId, updates: { status: newStatus } }));
                }
            }

            // Task Modal
            openTask(taskId) {
                const task = this.tasksData?.tasks?.find(t => t.id === taskId);
                if (!task) return;
                
                this.selectedTaskId = taskId;
                const agents = this.tasksData.agents || {};
                const assignee = task.assignee ? agents[task.assignee] : null;
                
                document.getElementById('modal-task-title').textContent = task.title;
                document.getElementById('modal-task-desc').textContent = task.description || 'No description';
                
                const priorityColors = {
                    high: 'text-status-alert',
                    medium: 'text-status-warning',
                    low: 'text-lcars-violet'
                };
                
                document.getElementById('modal-task-meta').innerHTML = `
                    <div class="text-center">
                        <div class="text-xs font-bold uppercase tracking-wider text-lcars-tan mb-1">Status</div>
                        <div class="text-sm text-lcars-gold">${this.columnLabels[task.status] || task.status}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs font-bold uppercase tracking-wider text-lcars-tan mb-1">Assignee</div>
                        <div class="text-sm text-lcars-gold">${assignee?.name || 'Unassigned'}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs font-bold uppercase tracking-wider text-lcars-tan mb-1">Priority</div>
                        <div class="text-sm font-bold ${priorityColors[task.priority] || priorityColors.medium}">${(task.priority || 'medium').toUpperCase()}</div>
                    </div>
                `;
                
                // Comments
                const comments = (task.comments || []).map(c => {
                    const author = agents[c.author] || { name: c.author, color: '#666', department: '?' };
                    return `
                        <div class="flex gap-2 p-2 bg-black/30 rounded-lg mb-2">
                            <div class="w-6 h-6 rounded-md flex items-center justify-center text-xs font-bold text-black flex-shrink-0" style="background: ${author.color}">${author.department}</div>
                            <div class="flex-1">
                                <div class="flex justify-between mb-0.5">
                                    <span class="text-xs font-bold text-lcars-gold">${author.name}</span>
                                    <span class="text-sm text-lcars-violet">${this.formatTimeAgo(c.timestamp)}</span>
                                </div>
                                <div class="text-sm text-lcars-sky">${this.escapeHtml(c.text)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('modal-task-comments').innerHTML = comments || '<div class="text-lcars-violet text-sm py-2.5">No comments yet</div>';
                document.getElementById('comments-count').textContent = (task.comments || []).length;
                
                // Activity log
                this.renderActivityLog(task);
                
                // Show activity count in header if there are logs
                const logCount = (task.logs || []).length;
                if (logCount > 0) {
                    document.getElementById('modal-task-title').innerHTML = `${this.escapeHtml(task.title)} <span class="text-xs text-lcars-gold ml-2">(${logCount} activity entries)</span>`;
                }
                
                // Files tab
                const files = task.files || [];
                document.getElementById('files-count').textContent = files.length;
                
                if (files.length > 0) {
                    const filesHtml = files.map(f => {
                        const lockIcon = f.locked ? `<span class="text-status-alert" title="Locked by ${f.lockedBy}">üîí</span>` : '<span class="text-lcars-sky">üìÑ</span>';
                        const lockInfo = f.locked ? `<span class="text-xs text-status-alert ml-2">Locked by ${f.lockedBy}</span>` : '';
                        return `
                            <div class="flex items-center gap-2 p-2 bg-black/30 rounded-lg mb-2 ${f.locked ? 'border border-status-alert/30' : ''}">
                                ${lockIcon}
                                <div class="flex-1">
                                    <div class="text-sm text-lcars-gold font-mono">${f.name}</div>
                                    <div class="text-xs text-lcars-violet truncate" title="${f.path}">${f.path}</div>
                                </div>
                                ${lockInfo}
                            </div>
                        `;
                    }).join('');
                    document.getElementById('files-list').innerHTML = filesHtml;
                } else {
                    document.getElementById('files-list').innerHTML = '<div class="text-center text-lcars-violet text-sm py-5">No files modified by this task</div>';
                }
                
                switchTaskTab('activity'); // Show activity by default
                const overlay = document.getElementById('task-modal-overlay');
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            }

            renderActivityLog(task) {
                const logs = task.logs || [];
                const agents = this.tasksData?.agents || {};
                const container = document.getElementById('activity-log-list');
                
                document.getElementById('activity-count').textContent = logs.length;
                
                if (logs.length === 0) {
                    container.innerHTML = '<div class="text-center text-lcars-violet text-sm py-5">No activity logged yet</div>';
                    return;
                }
                
                const sorted = [...logs].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                container.innerHTML = sorted.map((log, idx) => {
                    const agent = agents[log.agent] || { name: log.agent, color: '#666', department: '?' };
                    const hasDetails = log.toolName || log.toolArgs || log.payload || log.result || log.details;
                    const logId = `log-${task.id}-${idx}`;
                    
                    // Format details section if present
                    let detailsHtml = '';
                    if (hasDetails) {
                        const detailsContent = [];
                        if (log.toolName) {
                            detailsContent.push(`<div class="mb-2"><span class="text-lcars-teal text-xs font-bold">TOOL:</span> <span class="text-lcars-gold font-mono">${this.escapeHtml(log.toolName)}</span></div>`);
                        }
                        if (log.toolArgs) {
                            const argsStr = typeof log.toolArgs === 'object' ? JSON.stringify(log.toolArgs, null, 2) : log.toolArgs;
                            detailsContent.push(`<div class="mb-2"><span class="text-lcars-teal text-xs font-bold">ARGS:</span><pre class="text-lcars-sky text-xs font-mono mt-1 whitespace-pre-wrap break-all bg-black/30 p-2 rounded max-h-[150px] overflow-y-auto">${this.escapeHtml(argsStr)}</pre></div>`);
                        }
                        if (log.payload) {
                            const payloadStr = typeof log.payload === 'object' ? JSON.stringify(log.payload, null, 2) : log.payload;
                            detailsContent.push(`<div class="mb-2"><span class="text-lcars-teal text-xs font-bold">PAYLOAD:</span><pre class="text-lcars-sky text-xs font-mono mt-1 whitespace-pre-wrap break-all bg-black/30 p-2 rounded max-h-[150px] overflow-y-auto">${this.escapeHtml(payloadStr)}</pre></div>`);
                        }
                        if (log.result) {
                            const resultStr = typeof log.result === 'object' ? JSON.stringify(log.result, null, 2) : String(log.result);
                            const truncated = resultStr.length > 500 ? resultStr.substring(0, 500) + '...' : resultStr;
                            detailsContent.push(`<div class="mb-2"><span class="text-lcars-teal text-xs font-bold">RESULT:</span><pre class="text-lcars-green text-xs font-mono mt-1 whitespace-pre-wrap break-all bg-black/30 p-2 rounded max-h-[100px] overflow-y-auto">${this.escapeHtml(truncated)}</pre></div>`);
                        }
                        if (log.details && typeof log.details === 'object') {
                            detailsContent.push(`<div><span class="text-lcars-teal text-xs font-bold">DETAILS:</span><pre class="text-lcars-gold text-xs font-mono mt-1 whitespace-pre-wrap break-all bg-black/30 p-2 rounded max-h-[150px] overflow-y-auto">${this.escapeHtml(JSON.stringify(log.details, null, 2))}</pre></div>`);
                        }
                        detailsHtml = `<div class="activity-details">${detailsContent.join('')}</div>`;
                    }
                    
                    return `
                        <div class="activity-entry flex flex-col gap-0 p-2 bg-black/30 rounded-md mb-1.5 border-l-[3px] border-l-lcars-violet ${hasDetails ? '' : ''}" 
                             data-log-id="${logId}" 
                             onclick="${hasDetails ? `cc.toggleActivityDetails('${logId}')` : ''}">
                            <div class="flex gap-2">
                                <div class="w-6 h-6 rounded-md flex items-center justify-center text-xs font-bold text-black flex-shrink-0" style="background: ${agent.color}">${agent.department}</div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-center mb-0.5">
                                        <span class="text-xs font-bold text-lcars-gold">${agent.name}</span>
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm text-lcars-violet">${this.formatTimeAgo(log.timestamp)}</span>
                                            ${hasDetails ? '<span class="activity-expand-icon text-lcars-orange">‚ñ∂</span>' : ''}
                                        </div>
                                    </div>
                                    <div class="text-sm text-lcars-sky">
                                        <span class="activity-log-type inline-block px-1.5 py-0.5 rounded-sm text-sm font-bold uppercase mr-1.5 ${log.type || 'update'}">${log.type || 'update'}</span>
                                        ${this.escapeHtml(log.message)}
                                        ${hasDetails ? '<span class="text-sm text-lcars-tan ml-1">[details]</span>' : ''}
                                    </div>
                                </div>
                            </div>
                            ${detailsHtml}
                        </div>
                    `;
                }).join('');
            }

            toggleActivityDetails(logId) {
                const entry = document.querySelector(`[data-log-id="${logId}"]`);
                if (entry) {
                    entry.classList.toggle('expanded');
                }
            }

            addComment() {
                const input = document.getElementById('comment-input');
                const text = input.value.trim();
                if (!text || !this.selectedTaskId) return;
                
                if (this.ws?.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type: 'add_comment', taskId: this.selectedTaskId, author: 'seven', text }));
                    input.value = '';
                }
            }

            formatTimeAgo(ts) {
                if (!ts) return '--';
                // Sanitize malformed timestamps (e.g., double-Z suffix "ZZ")
                const cleanTs = typeof ts === 'string' ? ts.replace(/Z+$/, 'Z') : ts;
                const date = new Date(cleanTs);
                const time = date.getTime();
                if (isNaN(time)) return '--';
                const diff = Date.now() - time;
                if (diff < 0) return 'future';
                const mins = Math.floor(diff / 60000);
                if (mins < 1) return 'now';
                if (mins < 60) return `${mins}m`;
                const hours = Math.floor(mins / 60);
                if (hours < 24) return `${hours}h`;
                return `${Math.floor(hours / 24)}d`;
            }

            formatDuration(startedAt) {
                if (!startedAt) return '--';
                // Sanitize malformed timestamps (e.g., double-Z suffix "ZZ")
                const cleanTs = typeof startedAt === 'string' ? startedAt.replace(/Z+$/, 'Z') : startedAt;
                const date = new Date(cleanTs);
                const time = date.getTime();
                if (isNaN(time)) return '--';
                const diff = Math.floor((Date.now() - time) / 1000);
                if (diff < 0) return '--';
                if (diff < 60) return `${diff}s`;
                if (diff < 3600) return `${Math.floor(diff / 60)}m`;
                if (diff < 86400) return `${Math.floor(diff / 3600)}h`;
                return `${Math.floor(diff / 86400)}d`;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            startClock() {
                const update = () => {
                    document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-US', { 
                        hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'
                    });
                    
                    const now = new Date();
                    const startOfYear = new Date(now.getFullYear(), 0, 1);
                    const dayOfYear = Math.floor((now - startOfYear) / (1000 * 60 * 60 * 24));
                    const stardate = 47000 + ((now.getFullYear() - 2024) * 1000) + (dayOfYear / 365) * 1000;
                    document.getElementById('stardate').textContent = stardate.toFixed(1);
                };
                update();
                setInterval(update, 1000);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GLOBAL FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function closeTaskModal() {
            const overlay = document.getElementById('task-modal-overlay');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
            if (window.cc) window.cc.selectedTaskId = null;
        }

        async function deleteCurrentTask() {
            if (!window.cc?.selectedTaskId) return;
            if (!confirm('Delete this task? This cannot be undone.')) return;
            
            try {
                const res = await fetch(`/api/tasks/${window.cc.selectedTaskId}`, { method: 'DELETE' });
                if (res.ok) {
                    closeTaskModal();
                    // Refresh tasks
                    const tasksRes = await fetch('/api/tasks');
                    if (tasksRes.ok) {
                        window.cc.tasksData = await tasksRes.json();
                        window.cc.render();
                    }
                }
            } catch (e) {
                console.error('Delete failed:', e);
            }
        }

        function switchTaskTab(tabName) {
            document.querySelectorAll('.task-modal-tab').forEach(tab => {
                const isActive = tab.dataset.tab === tabName;
                tab.classList.toggle('text-lcars-orange', isActive);
                tab.classList.toggle('text-lcars-tan', !isActive);
                const badge = tab.querySelector('span');
                if (badge) {
                    badge.classList.toggle('bg-lcars-orange', isActive);
                    badge.classList.toggle('bg-lcars-violet', !isActive);
                }
            });
            document.querySelectorAll('.task-tab-content').forEach(content => {
                content.classList.toggle('hidden', content.id !== `tab-${tabName}`);
            });
        }

        function addComment() {
            if (window.cc) window.cc.addComment();
        }

        function showAddTask() {
            const overlay = document.getElementById('add-task-modal-overlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            document.getElementById('new-task-title').focus();
        }

        function closeAddTaskModal() {
            const overlay = document.getElementById('add-task-modal-overlay');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
            document.getElementById('add-task-form').reset();
        }

        async function submitNewTask(event) {
            event.preventDefault();
            
            const title = document.getElementById('new-task-title').value.trim();
            const description = document.getElementById('new-task-desc').value.trim();
            const assignee = document.getElementById('new-task-assignee').value || null;
            const priority = document.getElementById('new-task-priority').value;
            const category = document.getElementById('new-task-category').value;
            
            if (!title) return alert('Title required!');
            
            if (window.cc?.ws?.readyState === WebSocket.OPEN) {
                window.cc.ws.send(JSON.stringify({ type: 'create_task', title, description, assignee, priority, category }));
                closeAddTaskModal();
            }
        }

        function toggleView(view) {
            console.log('Toggle view:', view);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // META-LEARNING / LESSONS LEARNED
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        window.lessonsExpanded = false;
        window.lessonsData = null;

        function toggleLessons() {
            window.lessonsExpanded = !window.lessonsExpanded;
            const content = document.getElementById('lessons-content');
            const toggle = document.getElementById('lessons-toggle');
            
            if (window.lessonsExpanded) {
                content.classList.remove('hidden');
                toggle.textContent = '‚ñ≤';
                fetchLessons();
            } else {
                content.classList.add('hidden');
                toggle.textContent = '‚ñº';
            }
        }

        async function fetchLessons() {
            try {
                const res = await fetch('/api/meta-learning');
                const data = await res.json();
                window.lessonsData = data;
                renderLessons(data);
            } catch (err) {
                console.error('Failed to fetch lessons:', err);
                document.getElementById('lessons-list').innerHTML = '<div class="text-xs text-lcars-tan">Failed to load lessons</div>';
            }
        }

        function renderLessons(data) {
            const container = document.getElementById('lessons-list');
            if (!data || !data.lessons || data.lessons.length === 0) {
                container.innerHTML = '<div class="text-xs text-lcars-tan opacity-60">No lessons learned yet. Run analysis to gather insights.</div>';
                return;
            }
            
            // Group lessons by severity
            const severityIcons = {
                critical: 'üî¥',
                warning: '‚ö†Ô∏è',
                success: '‚úÖ',
                info: '‚ÑπÔ∏è'
            };
            
            const severityColors = {
                critical: 'text-red-400',
                warning: 'text-yellow-400',
                success: 'text-green-400',
                info: 'text-lcars-sky'
            };
            
            let html = '';
            
            // Stats summary
            if (data.statistics) {
                html += `<div class="text-xs text-lcars-tan mb-2 opacity-70">
                    üìä ${data.statistics.totalErrors || 0} errors tracked ¬∑ ${data.statistics.totalRecoveries || 0} recoveries
                </div>`;
            }
            
            // Top errors
            if (data.topErrors && data.topErrors.length > 0) {
                html += '<div class="text-xs mb-2"><span class="text-lcars-violet font-bold">Top Issues:</span></div>';
                for (const err of data.topErrors.slice(0, 3)) {
                    html += `<div class="text-xs text-lcars-tan pl-2">‚Ä¢ ${err.type}: ${err.count}x</div>`;
                }
            }
            
            // Agent reliability (top 5)
            if (data.agentReliability && data.agentReliability.length > 0) {
                html += '<div class="text-xs mt-2 mb-1"><span class="text-lcars-violet font-bold">Agent Reliability:</span></div>';
                const sorted = [...data.agentReliability].sort((a, b) => b.reliability - a.reliability).slice(0, 5);
                for (const agent of sorted) {
                    const pct = (agent.reliability * 100).toFixed(0);
                    const color = agent.reliability >= 0.8 ? 'text-green-400' : agent.reliability >= 0.5 ? 'text-yellow-400' : 'text-red-400';
                    const icon = agent.reliability >= 0.8 ? '‚úÖ' : agent.reliability >= 0.5 ? '‚ö†Ô∏è' : 'üî¥';
                    html += `<div class="text-xs pl-2"><span class="${color}">${icon} ${agent.agent}</span>: ${pct}% (${agent.tasks} tasks)</div>`;
                }
            }
            
            // Lessons
            if (data.lessons && data.lessons.length > 0) {
                html += '<div class="text-xs mt-2 mb-1"><span class="text-lcars-violet font-bold">Key Insights:</span></div>';
                for (const lesson of data.lessons.slice(0, 5)) {
                    const icon = severityIcons[lesson.severity] || '‚Ä¢';
                    const color = severityColors[lesson.severity] || 'text-lcars-tan';
                    html += `<div class="text-xs pl-2 ${color}">${icon} ${lesson.lesson}</div>`;
                }
            }
            
            // Pending improvements
            if (data.pendingImprovements > 0) {
                html += `<div class="text-xs mt-2 text-lcars-violet">üöÄ ${data.pendingImprovements} improvement suggestions pending</div>`;
            }
            
            // Last analysis time
            if (data.lastAnalysis) {
                const time = new Date(data.lastAnalysis).toLocaleString();
                html += `<div class="text-xs mt-2 text-lcars-tan opacity-50">Last analysis: ${time}</div>`;
            }
            
            container.innerHTML = html;
        }

        async function triggerAnalysis() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Analyzing...';
            
            try {
                const res = await fetch('/api/meta-learning/analyze', { method: 'POST' });
                const result = await res.json();
                
                if (result.success) {
                    btn.textContent = '‚úÖ Done!';
                    setTimeout(() => {
                        btn.textContent = 'üîÑ Run Analysis';
                        btn.disabled = false;
                        fetchLessons();
                    }, 1000);
                } else {
                    throw new Error(result.error);
                }
            } catch (err) {
                console.error('Analysis failed:', err);
                btn.textContent = '‚ùå Failed';
                setTimeout(() => {
                    btn.textContent = 'üîÑ Run Analysis';
                    btn.disabled = false;
                }, 2000);
            }
        }

        // Auto-fetch lessons periodically when expanded
        setInterval(() => {
            if (window.lessonsExpanded) {
                fetchLessons();
            }
        }, 60000); // Every minute when expanded

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MESSAGES SYSTEM
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        window.crewMessages = [];
        window.messageCounts = {};
        window.currentMessage = null;
        window.messageFilter = 'all';

        const CREW_NAMES = {
            seven: 'Seven of Nine',
            spock: 'Spock',
            geordi: 'Geordi La Forge',
            uhura: 'Uhura',
            quark: 'Quark'
        };

        function updateMessageBadge() {
            const badge = document.getElementById('msg-badge');
            const unread = window.messageCounts?.unread || 0;
            if (unread > 0) {
                badge.textContent = unread;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function openMessagesModal() {
            const modal = document.getElementById('messages-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            if (window.cc?.ws?.readyState === WebSocket.OPEN) {
                window.cc.ws.send(JSON.stringify({ type: 'get_messages' }));
            }
            renderMessageList();
        }

        function closeMessagesModal() {
            const modal = document.getElementById('messages-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function filterMessages(filter) {
            window.messageFilter = filter;
            document.querySelectorAll('.messages-filter').forEach(el => {
                el.classList.toggle('shadow-[0_0_10px_#FFCC99]', el.dataset.filter === filter);
            });
            renderMessageList();
        }

        function renderMessageList() {
            const container = document.getElementById('messages-list');
            let messages = [...(window.crewMessages || [])];
            
            const filter = window.messageFilter;
            if (filter === 'unread') messages = messages.filter(m => !m.read);
            else if (CREW_NAMES[filter]) messages = messages.filter(m => m.to === filter || m.from === filter);
            
            messages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="text-lcars-tan text-center py-8">No messages</div>';
                return;
            }
            
            container.innerHTML = messages.map(m => `
                <div class="message-item bg-lcars-violet/10 border-l-4 ${m.read ? 'border-l-lcars-violet' : 'border-l-status-alert'} px-3 py-2.5 mb-2 rounded-r-lcars cursor-pointer transition-all hover:bg-lcars-violet/20" onclick="selectMessage('${m.id}')">
                    <div class="text-xs text-lcars-sky mb-0.5 uppercase tracking-wider">${CREW_NAMES[m.from] || m.from} ‚Üí ${CREW_NAMES[m.to] || m.to}</div>
                    <div class="text-xs font-semibold text-lcars-gold mb-1">${escapeHtml(m.subject)}</div>
                    <div class="text-xs text-lcars-tan flex justify-between">
                        <span class="bg-lcars-violet text-black px-1.5 py-0.5 rounded-md text-sm font-bold">${m.type?.toUpperCase() || 'MSG'}</span>
                        <span>${formatMessageTime(m.timestamp)}</span>
                    </div>
                </div>
            `).join('');
        }

        function selectMessage(msgId) {
            const msg = window.crewMessages.find(m => m.id === msgId);
            if (!msg) return;
            
            window.currentMessage = msg;
            
            if (!msg.read) {
                fetch(`/api/messages/${msgId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ read: true })
                }).catch(() => {});
            }
            
            const detail = document.getElementById('message-detail');
            detail.classList.remove('hidden');
            detail.classList.add('flex');
            
            document.getElementById('detail-subject').textContent = msg.subject;
            document.getElementById('detail-meta').innerHTML = `From: <strong class="text-lcars-gold">${CREW_NAMES[msg.from] || msg.from}</strong> ‚Üí To: <strong class="text-lcars-gold">${CREW_NAMES[msg.to] || msg.to}</strong>`;
            document.getElementById('detail-content').textContent = msg.content || '(No content)';
            document.getElementById('detail-actions').classList.remove('hidden');
            document.getElementById('detail-actions').classList.add('flex');
        }

        function formatMessageTime(ts) {
            if (!ts) return '--';
            // Sanitize malformed timestamps (e.g., double-Z suffix "ZZ")
            const cleanTs = typeof ts === 'string' ? ts.replace(/Z+$/, 'Z') : ts;
            const date = new Date(cleanTs);
            const time = date.getTime();
            if (isNaN(time)) return '--';
            const diff = Date.now() - time;
            if (diff < 0) return '--';
            if (diff < 60000) return 'now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h';
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function ackMessage() {
            if (window.currentMessage) {
                fetch(`/api/messages/${window.currentMessage.id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'acknowledged' })
                }).then(() => renderMessageList());
            }
        }

        function createTaskFromMsg() {
            if (window.currentMessage) {
                document.getElementById('new-task-title').value = window.currentMessage.subject;
                document.getElementById('new-task-desc').value = window.currentMessage.content || '';
                closeMessagesModal();
                showAddTask();
            }
        }

        function deleteCurrentMsg() {
            if (window.currentMessage && confirm('Delete this message?')) {
                fetch(`/api/messages/${window.currentMessage.id}`, { method: 'DELETE' })
                    .then(() => {
                        window.currentMessage = null;
                        document.getElementById('message-detail').classList.add('hidden');
                        document.getElementById('message-detail').classList.remove('flex');
                        renderMessageList();
                    });
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INIT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let cc;
        document.addEventListener('DOMContentLoaded', () => {
            cc = new CommandCenter();
            window.cc = cc;
            cc.fetchSessions();
            cc.fetchTasks();
            console.log('[LCARS] Command Center v7.0 Tailwind Edition initialized');
        });
    </script>
</body>
</html>
